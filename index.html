<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32C3 BLE Control</title>
</head>
<body>
  <h1>BLE Control Panel</h1>
  <button id="connect">Connect to ESP32C3</button>
  <div id="status">Status: Not connected</div>
  <div>
    <h3>Sensor Data</h3>
    <p><strong>Encoder Position:</strong> <span id="encoderPos">N/A</span></p>
    <p><strong>Accelerometer:</strong> <span id="accelData">N/A</span></p>
  </div>

  <script>
    const SERVICE_UUID = "12345678-1234-1234-1234-1234567890ab";
    const CHARACTERISTIC_UUID = "abcdefab-1234-1234-1234-abcdefabcdef";
    let characteristic;

    document.getElementById("connect").addEventListener("click", async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [SERVICE_UUID]
        });

        document.getElementById("status").textContent = `Status: Connecting to ${device.name}`;

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

        await characteristic.startNotifications();
        characteristic.addEventListener("characteristicvaluechanged", handleNotifications);

        document.getElementById("status").textContent = "Status: Connected and receiving data";
      } catch (error) {
        console.error(error);
        document.getElementById("status").textContent = `Status: Error - ${error.message}`;
      }
    });

    function handleNotifications(event) {
      const value = new TextDecoder().decode(event.target.value);
      console.log("Received:", value);

      const parts = value.split(",");
      if (parts.length === 2) {
        document.getElementById("encoderPos").textContent = parts[0];
        document.getElementById("accelData").textContent = parts[1];
      } else {
        document.getElementById("encoderPos").textContent = value;
      }
    }
  </script>
</body>
</html>
